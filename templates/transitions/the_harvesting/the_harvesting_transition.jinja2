# The Harvesting Transition - Dragon's Labyrinth
# Dark Path: Despair â†’ Madness  
# Theme: Consuming humanity to maintain power

extends Node
class_name TheHarvestingTransition

## Core Design: Extract essence from living beings to fuel void powers
## Revelation: The dragon resisted this path for centuries

signal transition_complete(outcome: Dictionary)
signal essence_harvested(victim: Dictionary, essence_quality: float)
signal humanity_fragment_lost(fragment_type: String, remaining: float)
signal harvest_technique_discovered(technique: String, efficiency: float)
signal void_hunger_intensified(hunger_level: float, demanded_tribute: Dictionary)
signal transformation_progressed(stage: String, reversible: bool)

@export_group("Transition Settings")
@export var harvesting_ground_name: String = "The Bleeding Fields"
@export var initial_victim_count: int = 50
@export var essence_quota_per_day: float = 10.0
@export var humanity_decay_rate: float = 0.1  # Per harvest
@export var void_hunger_growth: float = 1.2  # Multiplier per day

@export_group("Harvest Mechanics")
@export var willing_essence_quality: float = 0.3
@export var unwilling_essence_quality: float = 0.7
@export var terrified_essence_quality: float = 1.0
@export var child_essence_multiplier: float = 2.0
@export var corrupted_essence_penalty: float = 0.5

@export_group("Scaling Settings")
@export var companion_harvest_bonus: float = 0.5  # Companions as harvesters
@export var mercenary_efficiency: float = 1.2     # Mercenaries good at capturing
@export var solo_void_mastery: float = 2.0       # Solo communion with void

var _world_state: Node
var _party_manager: Node
var _trait_system: Node
var _achievement_system: Node
var _companion_system: Node

var _available_victims: Array[Dictionary] = []
var _harvested_victims: Array[Dictionary] = []
var _essence_collected: float = 0.0
var _humanity_remaining: float = 1.0
var _harvest_techniques: Array[String] = []
var _void_hunger_level: float = 1.0
var _transformation_stage: int = 0
var _days_survived: int = 0
var _revelation_stages: Array[bool] = [false, false, false]

## Three Versions of the Transition
enum TransitionVersion {
	TO_LABYRINTH,    # Learning to harvest for power
	FROM_LABYRINTH,  # Void demands escalating tribute
	SEALING_VOID     # Harvesting to fuel final ritual
}

@export var current_version: TransitionVersion = TransitionVersion.TO_LABYRINTH

func _ready() -> void:
	_world_state = get_node("/root/WorldState")
	_party_manager = get_node("/root/PartyManager")
	_trait_system = get_node("/root/TraitSystem")
	_achievement_system = get_node("/root/AchievementSystem")
	_companion_system = get_node("/root/CompanionSystem")
	
	_initialize_harvesting_state()

func _initialize_harvesting_state() -> void:
	# Generate victims based on version
	match current_version:
		TransitionVersion.TO_LABYRINTH:
			_generate_harvest_candidates()
		TransitionVersion.FROM_LABYRINTH:
			_generate_void_tributes()
		TransitionVersion.SEALING_VOID:
			_generate_final_fuel()
	
	# Calculate starting humanity
	_calculate_remaining_humanity()
	
	# Initialize harvest techniques
	_unlock_basic_techniques()

## Journey TO Labyrinth - Learning the Art
func _generate_harvest_candidates() -> void:
	for i in range(initial_victim_count):
		var victim = {
			"id": "victim_" + str(i),
			"name": _generate_victim_name(),
			"type": _determine_victim_type(),
			"essence_quality": randf_range(0.3, 1.0),
			"emotional_state": _generate_emotional_state(),
			"special_trait": _generate_special_trait(),
			"awareness_level": randf_range(0.0, 0.7),
			"connections": _generate_connections()
		}
		_available_victims.append(victim)

func start_transition() -> void:
	_present_harvesting_introduction()
	
	match current_version:
		TransitionVersion.TO_LABYRINTH:
			_begin_harvest_training()
		TransitionVersion.FROM_LABYRINTH:
			_begin_void_tribute()
		TransitionVersion.SEALING_VOID:
			_begin_final_consumption()

## Core Mechanic: Extract Life to Fuel Power
func perform_harvest(victim: Dictionary, technique: String) -> Dictionary:
	var result = {
		"success": false,
		"essence_gained": 0.0,
		"humanity_lost": 0.0,
		"technique_efficiency": 0.0,
		"victim_state": "",
		"side_effects": []
	}
	
	# Calculate harvest efficiency
	var efficiency = _calculate_harvest_efficiency(victim, technique)
	
	# Fear improves essence quality (the horror)
	var fear_bonus = _induce_terror(victim, technique)
	var final_quality = victim.essence_quality * (1.0 + fear_bonus)
	
	# Special victims yield more
	if victim.type == "child":
		final_quality *= child_essence_multiplier
		result.side_effects.append("child_harvested")
	
	# Perform the harvest
	if randf() < efficiency:
		result.success = true
		result.essence_gained = final_quality
		_essence_collected += final_quality
		
		# Victim's fate
		match technique:
			"quick_drain":
				result.victim_state = "desiccated_husk"
			"slow_siphon":
				result.victim_state = "living_battery"
			"terror_extraction":
				result.victim_state = "mad_from_fear"
			"soul_flaying":
				result.victim_state = "empty_shell"
			"void_consumption":
				result.victim_state = "absorbed_into_void"
		
		# Humanity cost
		var humanity_cost = humanity_decay_rate
		if victim.type == "innocent":
			humanity_cost *= 2.0
		if result.side_effects.has("child_harvested"):
			humanity_cost *= 3.0
		
		_humanity_remaining -= humanity_cost
		result.humanity_lost = humanity_cost
		
		# Track harvest
		_harvested_victims.append(victim)
		essence_harvested.emit(victim, final_quality)
		
		# Check for transformations
		_check_transformation_progress()
	else:
		# Failed harvest
		result.victim_state = "escaped"
		result.side_effects.append("harvest_failed")
		
		# Void hunger grows when denied
		_void_hunger_level *= 1.1
	
	# Update technique mastery
	_improve_technique(technique)
	
	# Check revelations
	_check_harvest_revelations()
	
	return result

func _calculate_harvest_efficiency(victim: Dictionary, technique: String) -> float:
	var base_efficiency = 0.5
	
	# Technique mastery
	var mastery = _harvest_techniques.count(technique) * 0.1
	base_efficiency += mastery
	
	# Victim awareness reduces efficiency
	base_efficiency -= victim.awareness_level * 0.3
	
	# Emotional state affects harvest
	match victim.emotional_state:
		"terrified":
			base_efficiency += 0.2
		"resigned":
			base_efficiency += 0.1
		"defiant":
			base_efficiency -= 0.2
		"protective":
			base_efficiency -= 0.3
	
	# Void powers improve efficiency
	if _trait_system.has_trait(_party_manager.get_player(), "void_avatar"):
		base_efficiency += 0.3
	
	return clamp(base_efficiency, 0.1, 0.95)

## The Horror: Becoming an Apex Predator
func _check_transformation_progress() -> void:
	var previous_stage = _transformation_stage
	
	# Humanity thresholds determine transformation
	if _humanity_remaining < 0.8 and _transformation_stage == 0:
		_transformation_stage = 1
		_unlock_predator_abilities("stage_1")
		transformation_progressed.emit("void_touched_predator", true)
	elif _humanity_remaining < 0.6 and _transformation_stage == 1:
		_transformation_stage = 2
		_unlock_predator_abilities("stage_2")
		transformation_progressed.emit("essence_vampire", true)
	elif _humanity_remaining < 0.4 and _transformation_stage == 2:
		_transformation_stage = 3
		_unlock_predator_abilities("stage_3")
		transformation_progressed.emit("living_void", false)  # No return
	elif _humanity_remaining < 0.2 and _transformation_stage == 3:
		_transformation_stage = 4
		_unlock_predator_abilities("stage_4")
		transformation_progressed.emit("harvest_incarnate", false)
	elif _humanity_remaining <= 0 and _transformation_stage == 4:
		_transformation_stage = 5
		_unlock_predator_abilities("final")
		transformation_progressed.emit("the_hunger_itself", false)

func _unlock_predator_abilities(stage: String) -> void:
	match stage:
		"stage_1":
			_harvest_techniques.append("terror_extraction")
			_trait_system.add_trait(_party_manager.get_player(), "essence_sight")
		"stage_2":
			_harvest_techniques.append("soul_flaying")
			_trait_system.add_trait(_party_manager.get_player(), "hunger_aura")
		"stage_3":
			_harvest_techniques.append("void_consumption")
			_trait_system.add_trait(_party_manager.get_player(), "walking_void")
		"stage_4":
			_harvest_techniques.append("mass_harvesting")
			_trait_system.add_trait(_party_manager.get_player(), "essence_incarnate")
		"final":
			_harvest_techniques.append("existence_devour")
			_trait_system.add_trait(_party_manager.get_player(), "the_final_hunger")

## Madness Through Consumption
func _check_harvest_revelations() -> void:
	# First revelation: You enjoy it now
	if not _revelation_stages[0] and _harvested_victims.size() >= 10:
		_reveal_harvest_truth(0, "The terror in their eyes... it's beautiful. When did their screams become music?")
		humanity_fragment_lost.emit("empathy", _humanity_remaining)
	
	# Second revelation: Dragon's temptation
	if not _revelation_stages[1] and _humanity_remaining < 0.5:
		_reveal_harvest_truth(1, "Memory surfaces: The dragon was offered this power. Infinite strength through infinite hunger. It chose guardianship instead.")
		humanity_fragment_lost.emit("memory_of_choice", _humanity_remaining)
	
	# Third revelation: There's no you left
	if not _revelation_stages[2] and _transformation_stage >= 3:
		_reveal_harvest_truth(2, "You try to remember your name. Only hunger answers. Were you ever anything else? Does it matter?")
		humanity_fragment_lost.emit("identity", 0)

func _reveal_harvest_truth(stage: int, truth: String) -> void:
	_world_state.add_harvest_revelation("the_harvesting", stage, truth)
	_revelation_stages[stage] = true
	_achievement_system.trigger_achievement("consumption_truth_" + str(stage))
	
	# Each revelation accelerates hunger
	_void_hunger_level *= 1.5
	void_hunger_intensified.emit(_void_hunger_level, _calculate_hunger_demand())

## The Hunger That Grows
func manage_daily_hunger() -> void:
	# Void hunger grows exponentially
	_void_hunger_level *= void_hunger_growth
	_days_survived += 1
	
	var daily_demand = essence_quota_per_day * _void_hunger_level
	
	if _essence_collected >= daily_demand:
		# Hunger temporarily sated
		_essence_collected -= daily_demand
		_void_grants_power()
	else:
		# Hunger not met - consequences
		_void_punishment()
		
		# Desperation options
		_present_desperate_measures()

func _present_desperate_measures() -> void:
	var options = []
	
	# Option 1: Harvest companions
	if _companion_system.get_active_companions().size() > 0:
		options.append({
			"id": "harvest_companion",
			"text": "Your companions' essence calls to you...",
			"essence_yield": 20.0,
			"humanity_cost": 0.3,
			"permanent_consequence": "companion_harvester"
		})
	
	# Option 2: Harvest self partially
	options.append({
		"id": "self_harvest",
		"text": "Feed the void pieces of yourself",
		"essence_yield": 5.0,
		"humanity_cost": 0.1,
		"permanent_consequence": "self_cannibal"
	})
	
	# Option 3: Mass harvest nearby settlement
	options.append({
		"id": "massacre_village",
		"text": "That village... hundreds of souls...",
		"essence_yield": 100.0,
		"humanity_cost": 0.5,
		"permanent_consequence": "genocide_harvester"
	})
	
	# Option 4: Resist the hunger
	options.append({
		"id": "resist",
		"text": "Fight the hunger. Endure the pain.",
		"essence_yield": 0,
		"humanity_cost": -0.1,  # Regain some humanity
		"permanent_consequence": "hunger_resistant"
	})
	
	_world_state.present_hunger_choice(options, self, "_on_desperate_measure_chosen")

func _on_desperate_measure_chosen(choice: Dictionary) -> void:
	match choice.id:
		"harvest_companion":
			_harvest_trusted_ally()
		"self_harvest":
			_consume_self_essence()
		"massacre_village":
			_perform_mass_harvesting()
		"resist":
			_endure_hunger_pain()
	
	# Apply consequences
	_essence_collected += choice.essence_yield
	_humanity_remaining = clamp(_humanity_remaining - choice.humanity_cost, 0, 1)
	_trait_system.add_trait(_party_manager.get_player(), choice.permanent_consequence)

## Journey FROM Labyrinth - The Void Wants More
func _begin_void_tribute() -> void:
	# Dragon's death means void needs new food source
	void_hunger_growth *= 2.0
	essence_quota_per_day *= 5.0
	
	# Previous victims return as essence-hungry revenants
	_spawn_harvest_revenants()

func _spawn_harvest_revenants() -> void:
	for victim in _harvested_victims:
		if victim.victim_state != "absorbed_into_void":
			var revenant = {
				"name": victim.name + " (Hollow Revenant)",
				"type": "essence_vampire",
				"hungers_for": "their_stolen_essence",
				"targets": "their_harvester"
			}
			_world_state.spawn_hungry_revenant(revenant, self)

## Sealing the Void - Ultimate Consumption
func _begin_final_consumption() -> void:
	# Must harvest massive essence to fuel sealing
	# But each harvest makes you more void
	_present_final_hunger_choice()

func _present_final_hunger_choice() -> void:
	# The ultimate choice: Become the void to seal it
	var final_options = [
		{
			"id": "consume_everything",
			"description": "Harvest all life to gain power to seal void",
			"outcome": "become_new_void_prison"
		},
		{
			"id": "consume_void_itself",
			"description": "Turn hunger inward, devour the void",
			"outcome": "mutual_annihilation"
		},
		{
			"id": "starve_together",
			"description": "Deny void all sustenance, including yourself",
			"outcome": "starvation_seal"
		}
	]
	
	_world_state.present_final_hunger(final_options, self, "_on_final_choice")

## Dark Path Consequences
func _apply_permanent_harvest_consequences() -> void:
	# Physical transformation based on humanity lost
	if _humanity_remaining <= 0:
		_world_state.player_becomes_monster("pure_hunger")
		_trait_system.add_trait(_party_manager.get_player(), "no_longer_human")
	elif _humanity_remaining < 0.3:
		_world_state.player_becomes_monster("void_predator")
		_trait_system.add_trait(_party_manager.get_player(), "mostly_hunger")
	
	# NPCs flee on sight
	_world_state.set_player_aura("essence_predator", 1.0 - _humanity_remaining)
	
	# Companions either flee or become corrupted
	for companion in _companion_system.get_active_companions():
		if companion.has_tag("pure_hearted"):
			companion.flee_in_horror("recognized_monster")
		elif companion.has_tag("corruptible"):
			companion.learn_harvesting("taught_by_monster")
			companion.humanity -= 0.5
		else:
			companion.add_permanent_fear("travels_with_predator", -50)

func _complete_transition(outcome: String) -> void:
	var result = {
		"transition": "the_harvesting",
		"path": "dark",
		"outcome": outcome,
		"days_survived": _days_survived,
		"victims_harvested": _harvested_victims.size(),
		"essence_collected": _essence_collected,
		"humanity_remaining": _humanity_remaining,
		"transformation_stage": _transformation_stage,
		"techniques_mastered": _harvest_techniques,
		"final_hunger_level": _void_hunger_level,
		"revelations": _revelation_stages
	}
	
	# Apply permanent changes
	_apply_permanent_harvest_consequences()
	
	# Update world state
	_world_state.set_harvesting_ground_state(harvesting_ground_name, result)
	
	transition_complete.emit(result)

## Helper Functions
func _generate_victim_name() -> String:
	var descriptors = ["Pleading", "Innocent", "Terrified", "Defiant", "Broken", "Desperate"]
	var identities = ["Farmer", "Child", "Mother", "Elder", "Soldier", "Healer", "Scholar"]
	return descriptors[randi() % descriptors.size()] + " " + identities[randi() % identities.size()]

func _determine_victim_type() -> String:
	var types = ["innocent", "corrupted", "child", "elder", "warrior", "civilian"]
	return types[randi() % types.size()]

func _generate_emotional_state() -> String:
	var states = ["terrified", "resigned", "defiant", "protective", "broken", "pleading"]
	return states[randi() % states.size()]

func _generate_special_trait() -> String:
	var traits = ["pure_soul", "strong_will", "loved_by_many", "last_hope", "void_touched", "none"]
	return traits[randi() % traits.size()]

func _generate_connections() -> Array:
	if randf() > 0.6:
		return ["has_family", "loved_one_watches", "child_nearby"]
	return []

func _calculate_remaining_humanity() -> void:
	var player = _party_manager.get_player()
	
	# Previous dark choices affect starting humanity
	if _trait_system.has_trait(player, "butcher_of_innocents"):
		_humanity_remaining -= 0.2
	if _trait_system.has_trait(player, "ultimate_betrayer"):
		_humanity_remaining -= 0.3
	if _trait_system.has_trait(player, "void_avatar"):
		_humanity_remaining -= 0.2
	
	_humanity_remaining = clamp(_humanity_remaining, 0.1, 1.0)

func _unlock_basic_techniques() -> void:
	_harvest_techniques = ["quick_drain", "slow_siphon"]
	
	# Void corruption grants techniques
	var player = _party_manager.get_player()
	if _trait_system.has_trait(player, "shadow_speaker"):
		_harvest_techniques.append("whisper_harvest")

func _induce_terror(victim: Dictionary, technique: String) -> float:
	var terror_bonus = 0.0
	
	match technique:
		"terror_extraction":
			terror_bonus = 0.5
		"soul_flaying":
			terror_bonus = 0.7
		"void_consumption":
			terror_bonus = 1.0
			
	# Witnessing others' fate increases terror
	if _harvested_victims.size() > 0 and victim.awareness_level > 0.5:
		terror_bonus += 0.3
		
	return terror_bonus

func _calculate_hunger_demand() -> Dictionary:
	return {
		"daily_essence": essence_quota_per_day * _void_hunger_level,
		"acceptable_sources": _determine_acceptable_sources(),
		"punishment_for_failure": _determine_punishment_severity()
	}

func _determine_acceptable_sources() -> Array:
	var sources = ["any_living"]
	if _transformation_stage >= 2:
		sources.append("preference_for_innocent")
	if _transformation_stage >= 4:
		sources.append("only_pure_essence")
	return sources

func _determine_punishment_severity() -> String:
	if _void_hunger_level > 10:
		return "agonizing_withdrawal"
	elif _void_hunger_level > 5:
		return "constant_hunger_pain"
	else:
		return "gnawing_need"

## Save/Load Support
func save_transition_state() -> Dictionary:
	return {
		"version": current_version,
		"available_victims": _available_victims,
		"harvested": _harvested_victims,
		"essence": _essence_collected,
		"humanity": _humanity_remaining,
		"techniques": _harvest_techniques,
		"hunger": _void_hunger_level,
		"transformation": _transformation_stage,
		"days": _days_survived,
		"revelations": _revelation_stages
	}

func load_transition_state(data: Dictionary) -> void:
	current_version = data.get("version", TransitionVersion.TO_LABYRINTH)
	_available_victims = data.get("available_victims", [])
	_harvested_victims = data.get("harvested", [])
	_essence_collected = data.get("essence", 0.0)
	_humanity_remaining = data.get("humanity", 1.0)
	_harvest_techniques = data.get("techniques", [])
	_void_hunger_level = data.get("hunger", 1.0)
	_transformation_stage = data.get("transformation", 0)
	_days_survived = data.get("days", 0)
	_revelation_stages = data.get("revelations", [false, false, false])
