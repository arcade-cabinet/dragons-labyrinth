<!-- SYSTEM_PROMPT -->
You are creating the Lost Child Transition for Dragon's Labyrinth - the harmony path from PEACE to UNEASE.

NARRATIVE CONTEXT:
- Current emotional stage: {{ emotional_stage }}
- This triggers if player shows preference for helping others over combat
- Alternative to the Bandit Cave for compassionate players
- Where empathy becomes your first strength
- First companion gained through kindness, not combat

CORE CONCEPT - THE CRY IN THE DARKNESS:
A child is lost in the expanding fog at the edge of town. While others cower in fear, you venture into the unnatural mist. This tests compassion over combat, establishing you as protector rather than warrior.

THE EXPERIENCE:

1. **The Plea** (Moral choice):
   - Desperate mother at town square
   - "My daughter... she went into the fog..."
   - Guards refuse to help: "Nothing comes back from the fog"
   - Choice: Help immediately (compassion) or demand payment (pragmatic)

2. **Entering the Fog** (First taste of wrongness):
   - Visibility drops to mere feet
   - Sounds distort - child's cry seems to move
   - Your own footsteps echo wrong
   - Whispers in the fog: "Turn back..."

3. **The Search** (Environmental puzzle):
   - Must track child through increasingly dense fog
   - Sound-based navigation (cries get fainter)
   - Find disturbing clues: torn clothing, small footprints, blood?
   - Fog plays tricks - see child's silhouette that vanishes

4. **The Other Searcher** (First companion):
   - Meet another searching for the child
   - Could be:
     * Sibling who defied parents to search
     * Town outcast seeking redemption
     * Mysterious stranger who "hears the lost"
   - Must work together or fail

5. **The Truth** (Horror revelation):
   - Child found in clearing where fog is thickest
   - She's changed - eyes reflect too much light
   - She speaks of "the nice dragon who sings"
   - Drawings in dirt: crude dragon surrounded by smaller figures

6. **The Return** (Permanent change):
   - Fog follows you back, town boundary shifted
   - Child sometimes speaks in unknown language
   - Mother grateful but terrified of her own daughter
   - Companion bonds with you over shared experience
   - Town whispers about what you brought back

UNIQUE MECHANICS:

**Empathy Navigation:**
- No combat, pure environmental challenge
- Must interpret child's emotional state from cries
- Wrong choices make child flee deeper
- Companion provides emotional support

**Fog Mechanics:**
- Reduces visibility progressively
- Distorts sound direction
- Shows false visions based on fears
- Can only be navigated through trust

**Child Psychology:**
- Must approach carefully to not scare
- Speak soothingly (dialogue choices matter)
- Understand she's not entirely human anymore
- Choice: Tell mother truth or lie

SCALING ELEMENTS:
- If you have mercenaries: They refuse to enter fog
- If you have items: Torch helps but attracts... things
- If aggressive: Child flees, challenge becomes harder

PERMANENT CONSEQUENCES:
- Gain first companion (the other searcher)
- Trait: "Protector of Innocents" OR "Pragmatic Helper"
- Child becomes recurring character (prophet? threat?)
- Fog now permanent fixture near town
- Reputation: "The one who walks in fog"

THE THREE VERSIONS:

**Journey TO Labyrinth:**
- Establishes you as empathetic protector
- Child's visions hint at dragon's true nature
- Companion bonds through shared fear

**Journey FROM Labyrinth:**
- Child's condition worsens, speaks only dragon-tongue
- Fog has consumed half the town
- Mother begs you to "fix what you started"

**Sealing the VOID:**
- Child is portal for void whispers
- Must choose: Save child or save town
- Companion's trust crucial for solution

Generate complete implementation focusing on emotional challenge, environmental navigation, and establishing companion bonds through shared trauma.
<!-- /SYSTEM_PROMPT -->

<!-- FILE: lost_child_transition.gd -->
extends Node3D

class_name LostChildTransition

signal transition_complete(performance: Dictionary)
signal transition_failed(reason: String)
signal trait_gained(trait: String, amount: int)
signal companion_joined(companion: CompanionData)

@onready var fog_system = $FogSystem
@onready var audio_manager = $AudioManager
@onready var environment = $Environment
@onready var ui_manager = $UI
@onready var child_npc = $ChildNPC
@onready var mother_npc = $MotherNPC

var performance_tracker = {
    "empathy_shown": 0.0,
    "search_efficiency": 0.0,
    "child_trust": 0.0,
    "companion_bond": 0.0,
    "truth_handling": "",  # honest, protective_lie, avoided
    "time_in_fog": 0.0,
    "wrong_paths": 0,
    "approach_style": ""  # compassionate, pragmatic, reluctant
}

var fog_depth: float = 0.0
var child_fear_level: float = 1.0  # Starts terrified
var companion_trust: float = 0.0
var search_state: String = "following_cries"
var found_clues: Array[String] = []

# Audio cues for navigation
var child_cry_position: Vector3
var last_cry_time: float = 0.0
var cry_interval: float = 15.0  # Seconds between cries

const CLUES = {
    "torn_dress": "A piece of yellow fabric caught on thorns",
    "small_footprints": "Tiny footprints that sometimes have too many toes",
    "crayon": "A red crayon, still warm to the touch",
    "blood_drops": "Blood that glows faintly in the fog",
    "dragon_drawing": "Childish drawing of a dragon with many eyes"
}

func _ready():
    # Start with the mother's plea
    _setup_town_square()
    
    # Initialize fog as background element
    fog_system.set_density(0.1)
    fog_system.set_visibility_range(50.0)

func _setup_town_square():
    # Create desperate mother
    mother_npc.set_emotional_state("desperate")
    mother_npc.approach_player()
    
    # Guards in background
    var guards = preload("res://entities/npcs/town_guards.tscn").instantiate()
    add_child(guards)
    guards.set_behavior("avoidant")
    
    # Begin plea
    _initiate_mother_plea()

func _initiate_mother_plea():
    var dialogue = DialogueSystem.start_dialogue("mother_plea")
    
    dialogue.add_line("Please! My daughter... she went into the fog!")
    dialogue.add_line("The guards won't help. They say nothing returns from there.")
    dialogue.add_line("But I can still hear her crying! Please!")
    
    # Player choice
    dialogue.add_choices([
        {"text": "I'll find her. Stay here where it's safe.", "trait": "compassionate"},
        {"text": "This is dangerous. What can you offer?", "trait": "pragmatic"},
        {"text": "The guards are right. It's too risky.", "trait": "cautious"}
    ])
    
    var choice = await dialogue.choice_made
    _handle_initial_choice(choice)

func _handle_initial_choice(choice: DialogueChoice):
    performance_tracker.approach_style = choice.trait
    
    match choice.trait:
        "compassionate":
            trait_gained.emit("protector", 10)
            performance_tracker.empathy_shown += 0.3
            mother_npc.show_relief()
            _enter_fog_immediately()
            
        "pragmatic":
            var negotiation = await _negotiate_reward()
            if negotiation.accepted:
                trait_gained.emit("mercenary", 5)
                _enter_fog_prepared()
            else:
                transition_failed.emit("refused_quest")
                
        "cautious":
            mother_npc.increase_desperation()
            # Guilt trip attempt
            dialogue.add_line("She's only six years old...")
            var reconsider = await _offer_reconsideration()
            if reconsider:
                _enter_fog_reluctantly()
            else:
                transition_failed.emit("abandoned_child")

func _enter_fog_immediately():
    # Immediate entry, less prepared
    UI.show_narrative("You rush toward the fog without hesitation...")
    fog_system.begin_transition(2.0)
    _start_fog_sequence()

func _enter_fog_prepared():
    # Take time to prepare
    UI.show_narrative("You gather supplies before entering the fog...")
    GlobalState.add_item("rope", 1)
    GlobalState.add_item("lantern", 1)
    await get_tree().create_timer(2.0).timeout
    fog_system.begin_transition(3.0)
    _start_fog_sequence()

func _start_fog_sequence():
    # Dramatic fog entry
    fog_system.engulf_player()
    audio_manager.fade_out_ambient(2.0)
    audio_manager.start_fog_ambience()
    
    # Reduce visibility dramatically
    fog_system.set_visibility_range(5.0)
    
    # Start child cry mechanics
    _initialize_child_cries()
    
    # Enable fog navigation
    set_process(true)

func _initialize_child_cries():
    # Place child in fog
    child_npc.global_position = Vector3(
        randf_range(-30, 30),
        0,
        randf_range(-30, 30)
    )
    child_cry_position = child_npc.global_position
    
    # Start cry timer
    _schedule_next_cry()

func _schedule_next_cry():
    await get_tree().create_timer(cry_interval).timeout
    
    if search_state == "following_cries":
        _play_child_cry()
        
        # Cries get fainter over time
        cry_interval += 2.0
        audio_manager.reduce_cry_volume(0.1)
        
        # Schedule next
        _schedule_next_cry()

func _play_child_cry():
    # Distort position based on fog
    var distorted_position = child_cry_position + Vector3(
        randf_range(-fog_depth * 5, fog_depth * 5),
        0,
        randf_range(-fog_depth * 5, fog_depth * 5)
    )
    
    audio_manager.play_3d_sound("child_cry_fearful", distorted_position)
    
    # UI hint
    UI.show_directional_indicator(distorted_position, 2.0)
    
    # Update fear
    child_fear_level = min(1.0, child_fear_level + 0.1)

func _process(delta):
    if search_state != "following_cries":
        return
        
    performance_tracker.time_in_fog += delta
    fog_depth = min(1.0, performance_tracker.time_in_fog / 120.0)  # Max depth at 2 minutes
    
    # Check proximity to child
    var distance_to_child = global_position.distance_to(child_npc.global_position)
    
    if distance_to_child < 10.0 and not has_node("CompanionNPC"):
        _trigger_companion_encounter()
    elif distance_to_child < 3.0:
        _find_child()

func _trigger_companion_encounter():
    search_state = "companion_encounter"
    
    # Spawn companion
    var companion = preload("res://entities/companions/mysterious_searcher.tscn").instantiate()
    add_child(companion)
    companion.name = "CompanionNPC"
    
    # Position near player
    companion.global_position = global_position + Vector3(3, 0, 0)
    
    # Companion emerges from fog
    companion.emerge_from_fog()
    
    # Dialogue
    var dialogue = DialogueSystem.start_dialogue("companion_intro")
    
    match randi() % 3:
        0:  # Sibling
            companion.set_identity("worried_sibling")
            dialogue.add_line("Wait! Are you looking for Emma too? She's my sister!")
            dialogue.add_line("Mom said not to come but... I can hear her. Can't you?")
            
        1:  # Outcast
            companion.set_identity("town_outcast")
            dialogue.add_line("You... you're looking for the child.")
            dialogue.add_line("I hear all the lost ones. It's why they hate me.")
            
        2:  # Mysterious
            companion.set_identity("mysterious_stranger")
            dialogue.add_line("The fog speaks of a lost lamb.")
            dialogue.add_line("Will you accept help from one who walks between?")
    
    dialogue.add_choices([
        {"text": "We're stronger together. Let's find her.", "bond": 0.3},
        {"text": "Fine, but don't slow me down.", "bond": 0.1},
        {"text": "I work alone.", "bond": -0.2}
    ])
    
    var choice = await dialogue.choice_made
    _handle_companion_response(choice, companion)

func _handle_companion_response(choice: DialogueChoice, companion: Node3D):
    companion_trust = choice.bond
    
    if companion_trust >= 0:
        # Companion joins
        performance_tracker.companion_bond = companion_trust
        companion.join_player()
        
        # Companion ability helps
        UI.show_notification("Your companion can sense the child's direction better in the fog")
        child_cry_position = child_npc.global_position  # More accurate with help
        
        # Resume search together
        search_state = "following_cries"
        trait_gained.emit("cooperative", 5)
    else:
        # Rejected but they follow at distance
        companion.follow_at_distance()
        search_state = "following_cries"
        trait_gained.emit("loner", 5)

func _find_child():
    search_state = "found_child"
    set_process(false)
    
    # Reveal child in clearing
    fog_system.create_clearing(child_npc.global_position, 10.0)
    
    # Child appearance
    child_npc.visible = true
    child_npc.set_state("altered")
    
    # Unsettling details
    child_npc.set_eye_glow(true)
    child_npc.play_animation("drawing_in_dirt")
    
    # Environmental storytelling
    _create_dragon_drawings()
    
    # Approach carefully
    UI.show_notification("The child seems... different. Approach carefully.")
    
    # Enable interaction
    child_npc.interaction_available.connect(_interact_with_child)

func _create_dragon_drawings():
    var drawing_spots = []
    for i in 5:
        var offset = Vector3(randf_range(-2, 2), 0, randf_range(-2, 2))
        var drawing = preload("res://effects/ground_drawing.tscn").instantiate()
        add_child(drawing)
        drawing.global_position = child_npc.global_position + offset
        drawing.set_image("child_dragon_drawing")
        drawing_spots.append(drawing)
    
    # One special drawing
    drawing_spots[0].set_image("dragon_with_many_eyes")
    drawing_spots[0].add_glow(Color(1, 0, 0, 0.3))

func _interact_with_child():
    # Careful approach
    var approach_ui = preload("res://ui/careful_approach.tscn").instantiate()
    add_child(approach_ui)
    
    approach_ui.set_target(child_npc)
    approach_ui.set_fear_level(child_fear_level)
    
    # Player must move slowly, speak softly
    var success = await approach_ui.approach_completed
    
    if success:
        _child_interaction_success()
    else:
        _child_flees_deeper()

func _child_interaction_success():
    performance_tracker.child_trust = 1.0 - child_fear_level
    
    # Child speaks
    var dialogue = DialogueSystem.start_dialogue("altered_child")
    
    child_npc.look_at_player()
    dialogue.add_line("The dragon sings pretty songs...")
    dialogue.add_line("He shows me pictures in the fog...")
    dialogue.add_line("He says you're coming to visit him too!")
    
    # Show dragon drawing
    child_npc.point_at_drawing()
    
    # Companion reacts if present
    if has_node("CompanionNPC"):
        var companion = get_node("CompanionNPC")
        companion.show_concern()
        dialogue.add_line(companion.name + ": This isn't natural. What happened to her?")
    
    # Critical choice
    dialogue.add_choices([
        {"text": "It's okay. Let's get you home to mama.", "approach": "gentle"},
        {"text": "What else did the dragon tell you?", "approach": "investigate"},
        {"text": "Stay back! Something's wrong with you!", "approach": "fearful"}
    ])
    
    var choice = await dialogue.choice_made
    _handle_child_revelation(choice)

func _handle_child_revelation(choice: DialogueChoice):
    match choice.approach:
        "gentle":
            # Child comes willingly
            child_npc.follow_player()
            performance_tracker.empathy_shown += 0.3
            trait_gained.emit("compassionate", 10)
            _begin_return_journey()
            
        "investigate":
            # Learn more but child gets upset
            _reveal_dragon_truth()
            await get_tree().create_timer(3.0).timeout
            child_fear_level += 0.3
            _begin_return_journey()
            
        "fearful":
            # Child is hurt, companion helps
            child_npc.start_crying()
            if has_node("CompanionNPC"):
                get_node("CompanionNPC").comfort_child()
                performance_tracker.companion_bond += 0.2
            _begin_return_journey()

func _reveal_dragon_truth():
    # Child shares visions
    UI.show_vision_overlay()
    
    var visions = [
        "A dragon wrapped in chains of light...",
        "Something dark pressing against a barrier...",
        "The dragon's eyes full of ancient sadness...",
        "Void tendrils reaching through cracks..."
    ]
    
    for vision in visions:
        UI.show_vision_text(vision)
        await get_tree().create_timer(2.0).timeout
    
    UI.hide_vision_overlay()
    
    # Major revelation
    GlobalState.add_lore("dragon_as_guardian_hint")
    trait_gained.emit("insightful", 15)

func _begin_return_journey():
    # Fog follows
    fog_system.attach_to_player()
    
    # Navigate back
    UI.show_narrative("The fog seems to follow you as you return...")
    
    # Fast forward return
    await get_tree().create_timer(3.0).timeout
    
    # Back at town
    _return_to_town()

func _return_to_town():
    # Town edge scene
    fog_system.set_town_boundary_corruption()
    
    # Mother waiting
    mother_npc.run_to_child()
    
    # Reunion
    var dialogue = DialogueSystem.start_dialogue("mother_reunion")
    dialogue.add_line("Emma! Oh, my baby! You're... you're safe?")
    
    # Mother notices changes
    mother_npc.examine_child()
    dialogue.add_line("Your eyes... what happened to your eyes?")
    
    # Child response
    child_npc.speak_dragon_tongue()
    dialogue.add_line("*The child speaks in a language that hurts to hear*")
    
    # Final choice
    dialogue.add_choices([
        {"text": "She's been touched by something. But she's still your daughter.", "truth": "honest"},
        {"text": "She's fine, just scared. The fog plays tricks.", "truth": "lie"},
        {"text": "I... I don't know what I brought back.", "truth": "uncertain"}
    ])
    
    var choice = await dialogue.choice_made
    _handle_truth_choice(choice)

func _handle_truth_choice(choice: DialogueChoice):
    performance_tracker.truth_handling = choice.truth
    
    match choice.truth:
        "honest":
            # Mother accepts but is terrified
            mother_npc.hold_child_at_distance()
            trait_gained.emit("truthful", 10)
            GlobalState.town_reputation.add("honest_but_unsettling")
            
        "lie":
            # Mother relieved but suspicious
            mother_npc.embrace_child()
            trait_gained.emit("protective", 10)
            GlobalState.town_reputation.add("merciful_liar")
            
        "uncertain":
            # Creates fear in town
            mother_npc.back_away()
            trait_gained.emit("troubled", 5)
            GlobalState.town_reputation.add("harbinger_of_strangeness")
    
    # Companion becomes permanent if trust high enough
    if companion_trust > 0.5 and has_node("CompanionNPC"):
        _finalize_companion()
    
    # Complete transition
    _complete_transition()

func _finalize_companion():
    var companion = get_node("CompanionNPC")
    
    var dialogue = DialogueSystem.start_dialogue("companion_bond")
    dialogue.add_line(companion.name + ": After what we've seen... I don't think either of us should face this alone.")
    dialogue.add_line("Will you have me as a traveling companion?")
    
    # Auto-accept due to high trust
    UI.show_notification("A bond forged in fog and fear...")
    
    var companion_data = CompanionData.new()
    companion_data.initialize_from_node(companion)
    GlobalState.add_companion(companion_data)
    
    companion_joined.emit(companion_data)

func _complete_transition():
    # Calculate performance
    var empathy = performance_tracker.empathy_shown * 0.3
    var efficiency = (60.0 / max(1.0, performance_tracker.time_in_fog)) * 0.2
    var child = performance_tracker.child_trust * 0.2
    var companion = performance_tracker.companion_bond * 0.2
    var truth = 0.1 if performance_tracker.truth_handling == "honest" else 0.05
    
    performance_tracker["final_score"] = empathy + efficiency + child + companion + truth
    
    # World permanently changed
    GlobalState.current_phase = "unease"
    GlobalState.fog_presence = true
    GlobalState.add_special_npc("altered_child", child_npc.get_save_data())
    
    # Achievement check
    if performance_tracker.time_in_fog < 60.0 and performance_tracker.child_trust > 0.7:
        GlobalState.unlock_achievement("fog_walker")
    
    transition_complete.emit(performance_tracker)

<!-- FILE: fog_system.gd -->
extends Node3D

@onready var fog_volume = $FogVolume
@onready var fog_particles = $FogParticles
@onready var visibility_mask = $VisibilityMask
@onready var audio_distortion = $AudioDistortion

var current_density: float = 0.0
var visibility_range: float = 50.0
var attached_to_player: bool = false
var fog_whispers_active: bool = false

signal visibility_changed(new_range: float)
signal entered_deep_fog

func set_density(density: float):
    current_density = clamp(density, 0.0, 1.0)
    fog_volume.material.set_shader_parameter("density", current_density)
    
    # Affect visibility
    var new_visibility = lerp(50.0, 2.0, current_density)
    set_visibility_range(new_visibility)
    
    # Start whispers in deep fog
    if current_density > 0.7 and not fog_whispers_active:
        _activate_fog_whispers()

func set_visibility_range(range: float):
    visibility_range = range
    visibility_mask.set_radius(range)
    RenderingServer.environment_set_fog_depth_end(range)
    visibility_changed.emit(range)
    
    if range < 5.0:
        entered_deep_fog.emit()

func begin_transition(duration: float):
    var tween = create_tween()
    tween.tween_property(self, "current_density", 0.8, duration)
    tween.tween_callback(set_density.bind(0.8))

func engulf_player():
    # Dramatic fog entry
    fog_particles.emitting = true
    fog_particles.amount = 1000
    
    # Quick density increase
    var tween = create_tween()
    tween.tween_property(self, "current_density", 0.9, 0.5)
    
    # Audio muffling
    audio_distortion.enable_fog_filter()

func create_clearing(position: Vector3, radius: float):
    # Temporary clear spot in fog
    var clearing = preload("res://effects/fog_clearing.tscn").instantiate()
    add_child(clearing)
    clearing.global_position = position
    clearing.set_radius(radius)
    clearing.set_duration(30.0)

func attach_to_player():
    attached_to_player = true
    # Fog now follows player
    set_process(true)

func _process(_delta):
    if attached_to_player:
        var player = get_tree().get_first_node_in_group("player")
        if player:
            global_position = player.global_position

func set_town_boundary_corruption():
    # Permanent fog at town edge
    var boundary_fog = preload("res://effects/permanent_fog_wall.tscn").instantiate()
    get_parent().add_child(boundary_fog)
    boundary_fog.set_position(Vector3(0, 0, -50))  # Town edge
    
    # Creeping effect
    boundary_fog.set_creep_rate(0.1)  # Meters per day

func _activate_fog_whispers():
    fog_whispers_active = true
    
    # Periodic whispers
    _schedule_whisper()

func _schedule_whisper():
    if not fog_whispers_active:
        return
        
    await get_tree().create_timer(randf_range(10.0, 30.0)).timeout
    
    # Play whisper at random position
    var offset = Vector3(
        randf_range(-10, 10),
        0,
        randf_range(-10, 10)
    )
    
    AudioManager.play_3d("fog_whisper_dragon", global_position + offset)
    
    # Continue
    _schedule_whisper()

<!-- JSON: manifests/lost_child_content.json -->
{
  "transition": {
    "name": "Lost Child",
    "type": "peace_to_unease",
    "path": "harmony",
    "description": "Test of compassion and empathy in growing darkness",
    "key_mechanics": [
      "Environmental navigation",
      "Sound-based tracking",
      "Trust building",
      "Companion introduction",
      "No combat"
    ],
    "unique_features": {
      "fog_mechanics": "First introduction to supernatural fog",
      "altered_child": "Child touched by dragon becomes recurring character",
      "companion_bonding": "First companion through shared experience",
      "truth_choice": "Moral decision about revealing child's change",
      "dragon_hints": "First hints that dragon isn't evil"
    },
    "performance_metrics": {
      "empathy_shown": "Compassionate choices made",
      "search_efficiency": "Time to find child",
      "child_trust": "How well you calmed the child",
      "companion_bond": "Connection with fellow searcher",
      "truth_handling": "Honesty with mother"
    },
    "permanent_effects": {
      "traits_gained": ["protector/pragmatic", "cooperative/loner", "truthful/protective"],
      "companion": "Gains first companion through kindness",
      "world_changes": ["fog_at_town_edge", "altered_child_npc"],
      "reputation": ["fog_walker", "child_savior", "harbinger"],
      "lore": ["dragon_as_guardian_hint"]
    },
    "scaling_elements": {
      "with_mercenaries": "They refuse to enter fog, mock your compassion",
      "with_items": "Rope helps navigation, lantern attracts things",
      "aggressive_approach": "Child flees, much harder",
      "subsequent_versions": {
        "from_labyrinth": "Child's condition worse, mother blames you",
        "to_void": "Child is conduit for void, terrible choice required"
      }
    }
  }
}

<!-- PHILOSOPHY -->
The Lost Child is the emotional opposite of the Bandit Cave. Where one tests combat readiness, this tests emotional intelligence and compassion. The complete absence of combat reinforces that strength isn't always physical.

The fog serves as both mechanical challenge and metaphor - you can only navigate it through trust and empathy, not force. The altered child introduces the game's first hint that the dragon might not be evil, planting seeds that will bloom later.

The companion gained here bonds through shared fear and compassion, creating a deeper connection than any mercenary relationship. This establishes the fundamental difference between the two systems.

Most importantly, the child's transformation and the mother's reaction introduce the game's core theme: sometimes saving someone changes them in ways you didn't intend. The fog following you back shows that compassionate acts have consequences too.
