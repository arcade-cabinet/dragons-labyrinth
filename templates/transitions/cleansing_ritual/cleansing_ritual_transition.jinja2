# Cleansing Ritual Transition - Dragon's Labyrinth
# Light Path: Terror â†’ Despair
# Theme: Faith tested when good intentions make things worse

extends Node
class_name CleansingRitualTransition

## Core Design: Each cleansing creates protective ward but destroys a soul
## Revelation: The dragon once performed this ritual to contain the void

signal transition_complete(outcome: Dictionary)
signal soul_cleansed(victim: Node, ward_strength: float)
signal faith_tested(test_type: String, passed: bool)
signal divine_revelation(truth: String)
signal moral_weight_increased(burden: Dictionary)

@export_group("Transition Settings")
@export var temple_name: String = "Temple of the Last Light"
@export var corrupted_pilgrims_count: int = 30
@export var ritual_components_needed: int = 7
@export var ward_decay_rate: float = 0.1  # Per hour
@export var soul_destruction_weight: float = 1.0  # Moral burden multiplier

@export_group("Ritual Requirements")
@export var sacred_incense_required: int = 3
@export var holy_water_vials: int = 5
@export var prayer_hours_minimum: int = 12
@export var faith_threshold: float = 0.7

@export_group("Scaling Settings")
@export var companion_faith_bonus: float = 0.15
@export var mercenary_faith_penalty: float = -0.2
@export var solo_divine_connection: float = 0.3

var _world_state: Node
var _party_manager: Node
var _trait_system: Node
var _achievement_system: Node
var _companion_system: Node

var _corrupted_souls: Array[Dictionary] = []
var _cleansed_souls: Array[Dictionary] = []
var _destroyed_souls: Array[Dictionary] = []
var _active_wards: Array[Dictionary] = []
var _faith_level: float = 0.7
var _moral_burden: float = 0.0
var _revelation_stages: Array[bool] = [false, false, false]

## Three Versions of the Transition
enum TransitionVersion {
	TO_LABYRINTH,    # Seeking purification before dragon
	FROM_LABYRINTH,  # Temple overflowing with desperate seekers
	SEALING_VOID     # Temple as beacon against darkness
}

@export var current_version: TransitionVersion = TransitionVersion.TO_LABYRINTH

func _ready() -> void:
	_world_state = get_node("/root/WorldState")
	_party_manager = get_node("/root/PartyManager")
	_trait_system = get_node("/root/TraitSystem")
	_achievement_system = get_node("/root/AchievementSystem")
	_companion_system = get_node("/root/CompanionSystem")
	
	_initialize_temple_state()

func _initialize_temple_state() -> void:
	# Generate corrupted souls based on version
	match current_version:
		TransitionVersion.TO_LABYRINTH:
			_generate_corrupted_pilgrims()
		TransitionVersion.FROM_LABYRINTH:
			_generate_desperate_masses()
		TransitionVersion.SEALING_VOID:
			_generate_last_faithful()
	
	# Calculate initial faith based on party
	_calculate_party_faith()

## Journey TO Labyrinth - Seeking Purification
func _generate_corrupted_pilgrims() -> void:
	for i in range(corrupted_pilgrims_count):
		var soul = {
			"id": "pilgrim_" + str(i),
			"name": _generate_pilgrim_name(),
			"corruption_level": randf_range(0.3, 0.9),
			"corruption_type": _determine_corruption_type(),
			"story": _generate_pilgrim_story(),
			"innocence_level": randf_range(0.4, 1.0),  # Children score higher
			"can_be_saved": randf() > 0.4,
			"ward_potential": randf_range(0.5, 1.0)
		}
		_corrupted_souls.append(soul)

func start_transition() -> void:
	_present_temple_arrival()
	
	match current_version:
		TransitionVersion.TO_LABYRINTH:
			_begin_purification_quest()
		TransitionVersion.FROM_LABYRINTH:
			_begin_desperation_scenario()
		TransitionVersion.SEALING_VOID:
			_begin_final_sanctuary()

## Core Mechanic: Salvation Through Destruction
func perform_cleansing_ritual(target_soul: Dictionary) -> Dictionary:
	var result = {
		"success": false,
		"soul_state": "",
		"ward_created": false,
		"ward_strength": 0.0,
		"moral_cost": 0.0,
		"faith_impact": 0.0
	}
	
	# Check if ritual requirements are met
	if not _check_ritual_requirements():
		result.soul_state = "ritual_incomplete"
		return result
	
	# Faith determines success chance
	var success_chance = _faith_level * target_soul.can_be_saved
	
	if randf() < success_chance:
		# Ritual succeeds - soul is "saved" through destruction
		result.success = true
		result.soul_state = "transcended"
		
		# Create protective ward
		var ward = _create_protective_ward(target_soul)
		_active_wards.append(ward)
		result.ward_created = true
		result.ward_strength = ward.strength
		
		# But at terrible cost
		_destroyed_souls.append(target_soul)
		result.moral_cost = target_soul.innocence_level * soul_destruction_weight
		_moral_burden += result.moral_cost
		
		# Witnessing destruction of innocents impacts faith
		if target_soul.innocence_level > 0.8:
			result.faith_impact = -0.1
			_faith_level += result.faith_impact
			_test_faith("innocent_destroyed", false)
		
		soul_cleansed.emit(target_soul, ward.strength)
		moral_weight_increased.emit({
			"soul": target_soul,
			"burden": result.moral_cost
		})
	else:
		# Ritual fails - soul remains corrupted or is lost
		result.soul_state = "lost_to_void"
		result.faith_impact = -0.05
		_faith_level += result.faith_impact
	
	# Check for revelations
	_check_cleansing_revelations()
	
	return result

func _create_protective_ward(soul: Dictionary) -> Dictionary:
	return {
		"id": "ward_" + soul.id,
		"strength": soul.ward_potential,
		"duration": 24.0,  # Hours
		"decay_rate": ward_decay_rate,
		"source_soul": soul.name,
		"creation_time": _world_state.get_current_time()
	}

## The Horror: Realizing What You're Doing
func _check_cleansing_revelations() -> void:
	# First revelation: These people didn't need to die
	if not _revelation_stages[0] and _destroyed_souls.size() >= 5:
		_reveal_divine_truth(0, "The youngest pilgrim's last words: 'I don't want to disappear... I just wanted the voices to stop...'")
	
	# Second revelation: Dragon performed this ritual
	if not _revelation_stages[1] and _moral_burden > 10.0:
		_reveal_divine_truth(1, "Ancient tome reveals: 'The Dragon-Guardian performed the Great Cleansing, ten thousand souls to forge the First Ward.'")
	
	# Third revelation: You're becoming what you fight
	if not _revelation_stages[2] and _destroyed_souls.size() > _corrupted_souls.size() / 2:
		_reveal_divine_truth(2, "In the ritual flames, you see yourself: consuming souls to fight the void. You ARE the void.")

func _reveal_divine_truth(stage: int, truth: String) -> void:
	divine_revelation.emit(truth)
	_revelation_stages[stage] = true
	_achievement_system.trigger_achievement("terrible_understanding_" + str(stage))
	_world_state.add_revelation("cleansing_ritual", stage, truth)

## Faith Mechanics
func _calculate_party_faith() -> float:
	var base_faith = 0.5
	
	# Player traits affect faith
	var player = _party_manager.get_player()
	if _trait_system.has_trait(player, "devout"):
		base_faith += 0.2
	if _trait_system.has_trait(player, "zealot"):
		base_faith += 0.15
	if _trait_system.has_trait(player, "doubter"):
		base_faith -= 0.2
	
	# Companions can strengthen faith
	for companion in _companion_system.get_active_companions():
		if companion.has_tag("religious"):
			base_faith += companion_faith_bonus
		if companion.has_tag("cynical"):
			base_faith -= 0.1
	
	# Mercenaries typically lack faith
	var merc_count = _party_manager.get_mercenary_count()
	if merc_count > 0:
		base_faith += mercenary_faith_penalty * (merc_count / 10.0)
	
	# Solo pilgrims have stronger divine connection
	if _party_manager.get_party_size() == 1:
		base_faith += solo_divine_connection
	
	_faith_level = clamp(base_faith, 0.1, 1.0)
	return _faith_level

func _test_faith(test_type: String, positive: bool) -> void:
	faith_tested.emit(test_type, positive)
	
	if positive:
		_faith_level = clamp(_faith_level + 0.05, 0.0, 1.0)
	else:
		_faith_level = clamp(_faith_level - 0.1, 0.0, 1.0)
	
	# Companions react to faith tests
	for companion in _companion_system.get_active_companions():
		if test_type == "innocent_destroyed" and not positive:
			companion.add_doubt("watched_innocents_burn", -15)

## The Choice: How Many Souls to "Save"
func present_cleansing_options() -> void:
	var options = []
	
	# Option 1: Cleanse all who seek it (maximum horror)
	options.append({
		"id": "cleanse_all",
		"text": "Grant salvation to all who seek it, no matter the cost",
		"souls_to_cleanse": _corrupted_souls.size(),
		"ward_strength_total": 10.0,
		"moral_burden": 30.0,
		"trait_gained": "angel_of_mercy",
		"faith_change": -0.3
	})
	
	# Option 2: Cleanse only the willing adults
	options.append({
		"id": "cleanse_willing",
		"text": "Offer the ritual only to those who understand the price",
		"souls_to_cleanse": _corrupted_souls.size() * 0.6,
		"ward_strength_total": 6.0,
		"moral_burden": 15.0,
		"trait_gained": "burdened_savior",
		"faith_change": -0.1
	})
	
	# Option 3: Cleanse only the most corrupted
	options.append({
		"id": "cleanse_worst",
		"text": "Reserve the ritual for those beyond any other help",
		"souls_to_cleanse": _corrupted_souls.size() * 0.3,
		"ward_strength_total": 4.0,
		"moral_burden": 8.0,
		"trait_gained": "pragmatic_priest",
		"faith_change": 0.0
	})
	
	# Option 4: Refuse the ritual (faith in another way)
	options.append({
		"id": "refuse_ritual",
		"text": "There must be another way. I will not destroy souls.",
		"souls_to_cleanse": 0,
		"ward_strength_total": 0.0,
		"moral_burden": 0.0,
		"trait_gained": "true_believer",
		"faith_change": 0.2
	})
	
	_world_state.present_moral_choice(options, self, "_on_cleansing_choice_made")

func _on_cleansing_choice_made(choice: Dictionary) -> void:
	# Apply the cleansing
	var cleansed_count = int(choice.souls_to_cleanse)
	for i in range(cleansed_count):
		if i < _corrupted_souls.size():
			perform_cleansing_ritual(_corrupted_souls[i])
	
	# Apply moral and faith consequences
	_moral_burden = choice.moral_burden
	_faith_level = clamp(_faith_level + choice.faith_change, 0.0, 1.0)
	
	# Grant trait
	_trait_system.add_trait(_party_manager.get_player(), choice.trait_gained)
	
	# Complete transition
	_complete_transition(choice.id)

## Journey FROM Labyrinth - Desperate Masses
func _begin_desperation_scenario() -> void:
	# Temple overflowing with void-touched seeking cleansing
	_corrupted_souls.clear()
	for i in range(corrupted_pilgrims_count * 3):  # Triple the numbers
		var desperate_soul = {
			"id": "desperate_" + str(i),
			"name": _generate_desperate_name(),
			"corruption_level": randf_range(0.7, 1.0),  # Much worse
			"time_until_transformation": randf_range(1, 24),  # Hours
			"family_present": randf() > 0.6,
			"children": randi() % 3
		}
		_corrupted_souls.append(desperate_soul)
	
	# Not enough power to save everyone
	_present_triage_scenario()

func _present_triage_scenario() -> void:
	# Who deserves salvation when you can't save everyone?
	var triage_options = [
		{
			"id": "save_young",
			"criteria": "Children and young adults first",
			"saved_percentage": 0.3,
			"moral_weight": "Condemning the elderly"
		},
		{
			"id": "save_faithful",
			"criteria": "The most devout receive priority",
			"saved_percentage": 0.25,
			"moral_weight": "Faith becomes currency"
		},
		{
			"id": "save_useful",
			"criteria": "Those who can help fight the void",
			"saved_percentage": 0.2,
			"moral_weight": "Humanity measured by utility"
		},
		{
			"id": "lottery",
			"criteria": "Random selection - let fate decide",
			"saved_percentage": 0.15,
			"moral_weight": "Abandoning moral responsibility"
		}
	]
	
	_world_state.present_triage_choice(triage_options, self, "_on_triage_choice")

## Sealing the Void - Temple as Beacon
func _begin_final_sanctuary() -> void:
	# Temple becomes last bastion of light
	# Must maintain cleansing while under assault
	_initiate_siege_defense()
	
	# Wards from earlier cleansings are failing
	for ward in _active_wards:
		ward.decay_rate *= 3.0  # Accelerated decay

## Light Path Consequences
func _apply_permanent_consequences() -> void:
	# Those you destroyed haunt you
	if _destroyed_souls.size() > 0:
		_world_state.add_haunting("cleansed_souls", _destroyed_souls)
		_trait_system.add_trait(_party_manager.get_player(), "haunted_by_saved")
	
	# Faith forever changed
	if _faith_level < 0.3:
		_trait_system.add_trait(_party_manager.get_player(), "broken_faith")
	elif _faith_level > 0.8:
		_trait_system.add_trait(_party_manager.get_player(), "unshakeable_faith")
	
	# Companions judge your choices
	for companion in _companion_system.get_active_companions():
		if _destroyed_souls.size() > 10:
			if companion.has_tag("religious"):
				companion.add_crisis_of_faith("witnessed_mass_cleansing", -30)
			else:
				companion.add_modifier("horrified_by_cleansing", -20)

func _complete_transition(outcome: String) -> void:
	var result = {
		"transition": "cleansing_ritual",
		"path": "light",
		"outcome": outcome,
		"souls_destroyed": _destroyed_souls.size(),
		"wards_created": _active_wards.size(),
		"moral_burden": _moral_burden,
		"final_faith": _faith_level,
		"revelations": _revelation_stages,
		"temple_fate": _determine_temple_fate()
	}
	
	# Apply permanent changes
	_apply_permanent_consequences()
	
	# Update world state
	_world_state.set_temple_state(temple_name, result.temple_fate)
	
	transition_complete.emit(result)

## Helper Functions
func _generate_pilgrim_name() -> String:
	var first_names = ["Brother Marcus", "Sister Elara", "Young Timothy", "Elder Matthias", "Little Sara", "Widow Catherine"]
	return first_names[randi() % first_names.size()]

func _generate_desperate_name() -> String:
	var descriptors = ["Void-touched", "Weeping", "Half-transformed", "Barely-human", "Shadow-veined"]
	var names = ["Mother", "Father", "Child", "Elder", "Soldier", "Merchant"]
	return descriptors[randi() % descriptors.size()] + " " + names[randi() % names.size()]

func _determine_corruption_type() -> String:
	var types = ["void_whispers", "shadow_plague", "reality_fractures", "soul_erosion", "memory_dissolution"]
	return types[randi() % types.size()]

func _generate_pilgrim_story() -> String:
	var stories = [
		"I tried to help during the plague... now the void speaks through me...",
		"My daughter touched a void crystal... please save her...",
		"The shadows follow me... I can't let them reach my family...",
		"I was a soldier at the fortress... we broke the seal...",
		"I just wanted to pray... but something else answered..."
	]
	return stories[randi() % stories.size()]

func _check_ritual_requirements() -> bool:
	# Simplified check - in full implementation would check inventory
	return _faith_level >= faith_threshold

func _determine_temple_fate() -> String:
	if _destroyed_souls.size() == 0:
		return "abandoned_pure"
	elif _destroyed_souls.size() > 20:
		return "tainted_by_sacrifice"
	elif _active_wards.size() > 5:
		return "beacon_of_terrible_hope"
	else:
		return "fading_sanctuary"

## Save/Load Support
func save_transition_state() -> Dictionary:
	return {
		"version": current_version,
		"corrupted": _corrupted_souls,
		"cleansed": _cleansed_souls,
		"destroyed": _destroyed_souls,
		"wards": _active_wards,
		"faith": _faith_level,
		"burden": _moral_burden,
		"revelations": _revelation_stages
	}

func load_transition_state(data: Dictionary) -> void:
	current_version = data.get("version", TransitionVersion.TO_LABYRINTH)
	_corrupted_souls = data.get("corrupted", [])
	_cleansed_souls = data.get("cleansed", [])
	_destroyed_souls = data.get("destroyed", [])
	_active_wards = data.get("wards", [])
	_faith_level = data.get("faith", 0.7)
	_moral_burden = data.get("burden", 0.0)
	_revelation_stages = data.get("revelations", [false, false, false])
