<!-- SYSTEM_PROMPT -->
You are creating the sanity system for Dragon's Labyrinth at the {{ emotional_stage }} stage.

NARRATIVE CONTEXT:
- Previous state: {{ previous_state | default('none') }}
- Current state: {{ current_state | default('peace') }}
- Next state: {{ next_state | default('unease') }}
- Dread level: {{ dread_level | default(0) }}

CRITICAL PHILOSOPHY:
1. **Sanity â‰  Health Bar** - It's your grip on reality, not hit points
2. **Path Determines Relationship** - Holy fights insanity, Dark embraces it
3. **Holy = World Bends** - Your insanity warps reality itself around you
4. **Dark = Power Source** - Insanity fuels your demonic abilities
5. **Both Paths Ascend** - Holy after dragon (god), Dark before dragon (demon)

HOLY VS DARK SANITY PARADIGMS:

**Holy Path - Defender of Reality**:
- Low sanity makes THE WORLD go insane, not just you
- Reality bends and shifts in radius = 100/sanity meters
- NPCs flee, geometry warps, time stutters near you
- Faith and companions restore clarity
- At Mythic Tier: "Sanctuary Presence" - massive sanity restoration aura
- Draw strength from love and connection
- Earn at Forge pre-dragon OR post-dragon (second chance)

**Dark Path - Master of Madness**:
- Low sanity INCREASES your power dramatically
- Each 10 sanity lost = +15% dark magic damage
- You relish chaos, carefully balance madness/clarity
- Drain companions' life force for temporary clarity
- At Demonic Tier: "Nightmare Transcendence" - 0 sanity + perfect clarity
- Temporarily exist on demonic plane without consequences
- Earn at Dark Forge pre-dragon OR post-dragon (second chance)

SANITY MECHANICS BY STAGE:
{% if emotional_stage == "peace" %}
**Starting Fresh (90-100 sanity)**:
- Clear perception of reality
- Stress from leaving home (-5 sanity)
- Comfort from companions (+2/hour when near)
- Sleep restores sanity fully
- Food tastes good, music sounds beautiful

**First Cracks (70-90 sanity)**:
- Occasional double-takes at shadows
- Mild audio distortions at night
- Dreams becoming unsettling
- Still mostly functional
{% elif emotional_stage == "unease" %}
**Growing Paranoia (50-70 sanity)**:
- Shadows move in peripheral vision
- Whispers that might not be real
- Can't trust distant sounds
- Sleep brings nightmares (-5 sanity from rest)
- Food loses taste

**False Positives (30-50 sanity)**:
- See movement that isn't there
- Hear your name called by no one
- Dead companions "speak" occasionally
- Time distortion (hours feel like minutes)
{% elif emotional_stage == "dread" %}
**Reality Blurs (20-30 sanity)**:
- Hallucinate entire conversations
- See false NPCs who vanish when approached
- Hear dragon breathing when it's miles away
- Can't distinguish memory from present
- Written text changes when not looking

**Breaking Point (10-20 sanity)**:
- First-person horror moments
- World geometry seems wrong
- Multiple versions of companions
- Your own voice sounds foreign
{% elif emotional_stage == "terror" %}
**Shattered (5-10 sanity)**:
- Can't tell real companions from false
- Constant dragon presence
- Reality has multiple layers
- Time runs backwards occasionally
- Your reflection is wrong

**Gone (0-5 sanity)**:
- First-person only
- Nothing is certain
- Even UI might lie
- The dragon speaks through everything
{% elif emotional_stage == "horror" %}
**In the Labyrinth**:
- Sanity becomes different
- Not loss but transformation
- See reality as it truly is
- The dragon was always there
- This is clarity, not madness
{% endif %}

SANITY LOSS SOURCES:

1. **Environmental**:
   - Darkness: -1/minute without light
   - Corrupted biomes: -2/minute 
   - Dragon proximity: -10/minute within 100m
   - Witnessing horror: -5 to -20 instant
   - Companion death: -25 instant
   - Using dark magic: -5 per spell

2. **Combat**:
   - Killing humans: -10 first time, -5 thereafter
   - Being wounded: -2 per injury
   - Seeing allies fall: -5
   - Fighting alone: -1/minute
   - Using cursed weapons: -1/hit

3. **Existential**:
   - Realizing the scope: -15 (one time)
   - Finding empty villages: -5
   - Reading certain books: -10
   - Understanding the truth: -30
   - Accepting your fate: -50 or +50

SANITY RECOVERY METHODS:

1. **Human Connection**:
   - Companion proximity: +1-3/minute
   - Shared meals: +10
   - Conversations: +5
   - Being comforted: +15
   - Group singing/stories: +20

2. **Simple Pleasures**:
   - Good food: +5 (if >50 sanity)
   - Clean water: +3
   - Sunlight: +2/minute
   - Music: +5/song
   - Sleep: +20 (if >30 sanity)

3. **Faith/Purpose**:
   - Holy prayer: +10 (Holy path)
   - Blood ritual: +10 (Dark path)
   - Completing quests: +5-15
   - Saving someone: +20
   - Finding hope: +25

ALIGNMENT-SPECIFIC SANITY:

**Holy Path**:
- Angels in shadows at low sanity
- Hymns in the static  
- Dead companions encourage you
- Light pierces false visions
- Madness feels like divine revelation
- Can sacrifice sanity to heal others

**Dark Path**:
- Demons offer bargains at low sanity
- Whispers reveal hidden power
- Dead companions serve you
- Shadows hide truths from others
- Madness feels like ascension
- Can sacrifice others' sanity for power

**Mixed Party Dynamics**:
- Holy players see Dark players' true forms
- Dark players hear Holy players' doubts
- Shared hallucinations create bonds
- Reality rifts where perceptions clash

FALSE REALITY MECHANICS:

1. **Visual Hallucinations**:
   - False enemies (waste resources)
   - Fake treasures (disappear when touched)
   - Dead companions walking
   - Walls that aren't there
   - Doors that don't exist

2. **Audio Hallucinations**:
   - Voices of the dead
   - Dragon breathing (everywhere)
   - Your name whispered
   - Sounds from home
   - Future screams

3. **Temporal Distortions**:
   - Time skips
   - Repeated moments
   - Future memories
   - Past bleeding through
   - Cause before effect

4. **UI Deception** (below 20 sanity):
   - False health values
   - Inventory items that don't exist
   - Map locations that are wrong
   - Quest objectives that change
   - Controls occasionally reversed

FIRST-PERSON SANITY BREAKS:
Triggered at specific thresholds:
- 50: First major hallucination
- 25: Reality breakdown scene
- 10: Complete dissociation
- 0: Meeting your other self

TECHNICAL REQUIREMENTS:
- Visual distortion shaders
- Dynamic audio filtering
- False entity spawning system
- Memory playback system
- First-person horror sequences
- UI corruption effects

Generate a sanity system where madness isn't failure but transformation, where low sanity reveals as much as it obscures, and where the question "Is this real?" has no good answer.
<!-- /SYSTEM_PROMPT -->

<!-- FILE: sanity_controller.gd -->
extends Node
class_name SanityController

# The threads that bind us to consensus reality

signal sanity_changed(new_value: float, change: float)
signal hallucination_started(type: String, data: Dictionary)
signal reality_break_triggered(severity: int)
signal perception_shifted(new_mode: String)
signal false_reality_spawned(entity: Node3D)
signal ui_corruption_started(element: String)

@export var emotional_stage: String = "peace"
@export var player_alignment: String = "neutral"  # "holy", "dark", "neutral"

# Not hit points, but grip on reality
var current_sanity: float = 95.0
var max_sanity: float = 100.0
var sanity_change_rate: float = 0.0  # Current per-second change
var temporary_modifiers: Array[Dictionary] = []

# Thresholds of transformation
const PARANOID_THRESHOLD = 70.0
const HALLUCINATION_THRESHOLD = 50.0
const REALITY_BREAK_THRESHOLD = 30.0
const SHATTERED_THRESHOLD = 10.0
const GONE_THRESHOLD = 5.0

# Perception state
var perception_mode: String = "clear"  # "clear", "paranoid", "hallucinatory", "shattered", "gone"
var active_hallucinations: Array[Dictionary] = []
var false_entities: Array[Node3D] = []
var reality_break_active: bool = false

# Memory and time
var memory_fragments: Array[Dictionary] = []
var time_distortion_factor: float = 1.0
var false_memories: Array[String] = []

# Alignment-specific tracking
var divine_visions_seen: int = 0
var dark_whispers_heard: int = 0
var reality_rifts_created: int = 0

# First person thresholds
var fp_thresholds_triggered: Dictionary = {
    50: false,
    25: false,
    10: false,
    0: false
}

func _ready() -> void:
    # Reality is consensual until it isn't
    _initialize_perception_systems()
    _connect_environmental_factors()
    
    # Set starting sanity based on emotional stage
    match emotional_stage:
        "peace": current_sanity = 95.0
        "unease": current_sanity = 75.0
        "dread": current_sanity = 55.0
        "terror": current_sanity = 35.0
        "horror": current_sanity = 15.0

func _process(delta: float) -> void:
    # Sanity constantly shifts
    _update_sanity(delta)
    _check_perception_shifts()
    _process_active_hallucinations(delta)
    
    # Reality becomes less stable
    if current_sanity < REALITY_BREAK_THRESHOLD:
        _distort_reality(delta)

func _update_sanity(delta: float) -> void:
    # Calculate total change rate
    var total_rate = sanity_change_rate
    
    # Add temporary modifiers
    for modifier in temporary_modifiers:
        total_rate += modifier.rate
        modifier.duration -= delta
    
    # Remove expired modifiers
    temporary_modifiers = temporary_modifiers.filter(func(m): return m.duration > 0)
    
    # Apply change
    if total_rate != 0:
        modify_sanity(total_rate * delta)

func modify_sanity(amount: float, source: String = "") -> void:
    var old_sanity = current_sanity
    current_sanity = clamp(current_sanity + amount, 0.0, max_sanity)
    
    var actual_change = current_sanity - old_sanity
    if actual_change != 0:
        sanity_changed.emit(current_sanity, actual_change)
        
        # Store traumatic memories
        if amount < -10:
            memory_fragments.append({
                "trauma": source,
                "sanity_lost": abs(amount),
                "timestamp": Time.get_ticks_msec()
            })
        
        # Check for first-person triggers
        _check_first_person_triggers(old_sanity, current_sanity)

func _check_perception_shifts() -> void:
    var new_mode = perception_mode
    
    if current_sanity >= PARANOID_THRESHOLD:
        new_mode = "clear"
    elif current_sanity >= HALLUCINATION_THRESHOLD:
        new_mode = "paranoid"
    elif current_sanity >= REALITY_BREAK_THRESHOLD:
        new_mode = "hallucinatory"
    elif current_sanity >= GONE_THRESHOLD:
        new_mode = "shattered"
    else:
        new_mode = "gone"
    
    if new_mode != perception_mode:
        perception_mode = new_mode
        perception_shifted.emit(new_mode)
        _activate_perception_effects(new_mode)

func _activate_perception_effects(mode: String) -> void:
    match mode:
        "paranoid":
            # Shadows move, sounds distort
            Events.emit_signal("enable_paranoid_visuals")
            AudioManager.distortion_level = 0.1
            
        "hallucinatory":
            # False entities, time skips
            AudioManager.distortion_level = 0.3
            _start_spawning_hallucinations()
            
        "shattered":
            # Reality breaks down
            AudioManager.distortion_level = 0.6
            _enable_reality_breaks()
            GameState.allow_ui_corruption = true
            
        "gone":
            # Nothing is real
            AudioManager.distortion_level = 1.0
            _total_reality_collapse()

func add_environmental_drain(rate: float, source: String) -> void:
    # Darkness, corruption, proximity to horror
    sanity_change_rate += rate
    
    # Track what's affecting us
    Events.emit_signal("sanity_drain_started", source, rate)

func remove_environmental_drain(source: String) -> void:
    # Left the dark place, but memory remains
    Events.emit_signal("sanity_drain_ended", source)
    # Rate recalculation happens elsewhere

func witness_horror(horror_type: String, severity: int) -> void:
    # Some things can't be unseen
    var loss = -5 * severity
    
    match horror_type:
        "companion_death":
            loss = -25
            _create_death_memory()
        "first_kill":
            loss = -10 if player_alignment != "dark" else -5
        "mass_grave":
            loss = -15
        "truth_revealed":
            loss = -30
            false_memories.append("Everything was fine")
    
    modify_sanity(loss, horror_type)
    
    # Immediate hallucination chance
    if randf() < abs(loss) / 50.0:
        _trigger_trauma_hallucination(horror_type)

func gain_comfort(source: String, amount: float) -> void:
    # Human connection matters
    match source:
        "companion_proximity":
            if current_sanity > 30:  # Can't help if too far gone
                modify_sanity(amount)
                
        "shared_meal":
            modify_sanity(10)
            memory_fragments.append({
                "comfort": "meal_with_friends",
                "sanity_gained": 10,
                "timestamp": Time.get_ticks_msec()
            })
            
        "holy_prayer":
            if player_alignment == "holy":
                modify_sanity(10)
                divine_visions_seen += 1
                
        "blood_ritual":
            if player_alignment == "dark":
                modify_sanity(10)
                dark_whispers_heard += 1

func _start_spawning_hallucinations() -> void:
    # False reality intrudes
    var hallucination_types = []
    
    match emotional_stage:
        "unease":
            hallucination_types = ["shadow_movement", "false_sounds", "peripheral_figures"]
        "dread":
            hallucination_types = ["dead_companions", "false_npcs", "time_loops"]
        "terror":
            hallucination_types = ["dragon_everywhere", "reality_layers", "self_duplication"]
        "horror":
            hallucination_types = ["truth_visions", "future_echoes", "the_real_world"]
    
    # Spawn based on alignment
    if player_alignment == "holy":
        hallucination_types.append("divine_messengers")
    elif player_alignment == "dark":
        hallucination_types.append("demon_bargains")
    
    var chosen = hallucination_types[randi() % hallucination_types.size()]
    _spawn_hallucination(chosen)

func _spawn_hallucination(type: String) -> void:
    hallucination_started.emit(type, {
        "duration": randf_range(5.0, 30.0),
        "intensity": 1.0 - (current_sanity / 100.0)
    })
    
    match type:
        "dead_companions":
            _spawn_false_companion()
        "false_npcs":
            _spawn_false_npc()
        "dragon_everywhere":
            _spawn_dragon_presence()
        "divine_messengers":
            _spawn_angel()
        "demon_bargains":
            _spawn_demon()

func _spawn_false_companion() -> void:
    # They died, but here they are
    if GameState.lost_companions.is_empty():
        return
        
    var dead = GameState.lost_companions[randi() % GameState.lost_companions.size()]
    var false_companion = preload("res://entities/hallucinations/false_companion.tscn").instantiate()
    
    false_companion.setup(dead)
    false_companion.global_position = GameState.player.global_position + Vector3(randf_range(-5, 5), 0, randf_range(-5, 5))
    
    false_entities.append(false_companion)
    get_tree().current_scene.add_child(false_companion)
    false_reality_spawned.emit(false_companion)
    
    # They might speak
    if randf() < 0.5:
        await get_tree().create_timer(2.0).timeout
        Events.emit_signal("hallucination_speaks", dead.name, "Why did you let me die?")

func corrupt_ui_element(element: String) -> void:
    # Even the interface lies now
    if current_sanity > 20:
        return
        
    ui_corruption_started.emit(element)
    
    match element:
        "health":
            # Show false health values
            GameState.false_health = randi_range(1, 100)
        "inventory":
            # Items that don't exist
            _add_false_inventory_item()
        "map":
            # Locations that aren't real
            _corrupt_map_data()
        "objectives":
            # Quests that were never given
            _inject_false_quest()

func _check_first_person_triggers(old_sanity: float, new_sanity: float) -> void:
    # Major breaks trigger perspective shifts
    for threshold in fp_thresholds_triggered:
        if old_sanity > threshold and new_sanity <= threshold and not fp_thresholds_triggered[threshold]:
            fp_thresholds_triggered[threshold] = true
            _trigger_first_person_break(threshold)

func _trigger_first_person_break(threshold: float) -> void:
    match threshold:
        50.0:
            Events.emit_signal("first_person_moment", "first_major_hallucination")
        25.0:
            Events.emit_signal("first_person_moment", "reality_breakdown")
        10.0:
            Events.emit_signal("first_person_moment", "complete_dissociation")
        0.0:
            Events.emit_signal("first_person_moment", "meeting_yourself")

func _distort_reality(delta: float) -> void:
    # Time isn't stable anymore
    time_distortion_factor = 1.0 + sin(Time.get_ticks_msec() * 0.001) * (1.0 - current_sanity / 30.0)
    Engine.time_scale = time_distortion_factor
    
    # Memories bleed through
    if randf() < 0.01 * delta:
        _replay_memory_fragment()

func _replay_memory_fragment() -> void:
    if memory_fragments.is_empty():
        return
        
    var memory = memory_fragments[randi() % memory_fragments.size()]
    
    # You're there again
    Events.emit_signal("memory_replay_started", memory)
    
    # But it's different this time
    if current_sanity < 10:
        memory.altered = true
        memory.new_ending = "everyone_dies"

# Sanity isn't health
# It's perspective
# Who decides what's real?
# In the labyrinth, madness might be clarity
<!-- /FILE -->

<!-- FILE: hallucination_system.gd -->
extends Node
class_name HallucinationSystem

# What you see when reality thins

signal false_entity_spawned(entity: Node3D, type: String)
signal false_sound_played(sound: String, position: Vector3)
signal reality_glitch_occurred(glitch_type: String)
signal perception_war_started(holy_vision: String, dark_vision: String)

@export var sanity_controller: SanityController

# Types of unreality
var visual_hallucinations: Array[Dictionary] = []
var audio_hallucinations: Array[Dictionary] = []
var temporal_anomalies: Array[Dictionary] = []
var false_npcs: Array[Node3D] = []

# Alignment-specific visions
var holy_visions: Array[String] = [
    "angel_in_shadows",
    "light_through_corruption", 
    "divine_geometry",
    "salvation_paths",
    "martyr_memories"
]

var dark_visions: Array[String] = [
    "demon_negotiations",
    "power_currents",
    "sacrifice_opportunities",
    "weakness_highlights",
    "ascension_visions"
]

# Multi-player perception conflicts
var perception_conflicts: Dictionary = {}

func _ready() -> void:
    if not sanity_controller:
        sanity_controller = get_node("/root/SanityController")
    
    sanity_controller.hallucination_started.connect(_on_hallucination_triggered)
    sanity_controller.perception_shifted.connect(_on_perception_shifted)

func spawn_false_companion(dead_companion_data: Dictionary) -> Node3D:
    # They're dead but you see them
    var false_companion = preload("res://entities/hallucinations/false_entity.tscn").instantiate()
    
    false_companion.configure({
        "appearance": dead_companion_data.appearance,
        "name": dead_companion_data.name,
        "behavior": "follow_and_speak",
        "phrases": [
            "Why did you leave me?",
            "It's cold here.",
            "I can't find my way.",
            "You promised we'd go home."
        ],
        "disappear_on_touch": true,
        "sanity_requirement": 50  # Only visible below 50 sanity
    })
    
    # Position behind player
    var behind = -GameState.player.global_transform.basis.z * 5
    false_companion.global_position = GameState.player.global_position + behind
    
    false_entity_spawned.emit(false_companion, "dead_companion")
    return false_companion

func spawn_false_npc(context: String) -> Node3D:
    # People who were never there
    var false_npc = preload("res://entities/hallucinations/false_entity.tscn").instantiate()
    
    var npc_configs = {
        "unease": {
            "appearance": "traveling_merchant",
            "behavior": "offer_false_trades",
            "items": ["sanity_potion", "way_home", "forget_medicine"]
        },
        "dread": {
            "appearance": "lost_villager", 
            "behavior": "beg_for_help",
            "leads_to": "empty_space"
        },
        "terror": {
            "appearance": "yourself",
            "behavior": "mirror_actions",
            "speaks": "your_thoughts"
        }
    }
    
    var config = npc_configs.get(context, npc_configs.unease)
    false_npc.configure(config)
    
    false_entity_spawned.emit(false_npc, "false_npc")
    return false_npc

func create_perception_conflict(location: Vector3) -> void:
    # When party members see different realities
    if not MultiplayerManager.is_coop_active:
        return
    
    var holy_player = MultiplayerManager.get_holy_aligned_player()
    var dark_player = MultiplayerManager.get_dark_aligned_player()
    
    if holy_player and dark_player:
        # Same location, different realities
        var conflict = {
            "location": location,
            "holy_sees": holy_visions[randi() % holy_visions.size()],
            "dark_sees": dark_visions[randi() % dark_visions.size()],
            "resolution": "reality_rift"
        }
        
        perception_conflicts[location] = conflict
        perception_war_started.emit(conflict.holy_sees, conflict.dark_sees)
        
        # Create visual distortion at conflict point
        _spawn_reality_rift(location)

func trigger_false_audio(sanity_level: float) -> void:
    # Sounds that aren't there
    var sound_pools = {
        "high_sanity": ["whispered_name", "distant_bell", "footsteps_behind"],
        "medium_sanity": ["companion_crying", "dragon_breathing", "home_sounds"],
        "low_sanity": ["your_voice_elsewhere", "future_screams", "the_truth"],
        "no_sanity": ["everything_speaking", "silence_screaming", "real_sounds"]
    }
    
    var pool = "high_sanity"
    if sanity_level < 30:
        pool = "low_sanity"
    elif sanity_level < 60:
        pool = "medium_sanity"
    elif sanity_level < 10:
        pool = "no_sanity"
    
    var sounds = sound_pools[pool]
    var chosen = sounds[randi() % sounds.size()]
    
    # Position it wrong
    var false_position = GameState.player.global_position + Vector3(
        randf_range(-20, 20),
        randf_range(-5, 5),
        randf_range(-20, 20)
    )
    
    false_sound_played.emit(chosen, false_position)
    AudioManager.play_3d_sound(chosen, false_position, true)  # true = hallucination

func distort_time_perception(intensity: float) -> void:
    # Time isn't linear anymore
    var distortion_type = "mild_skip"
    
    if intensity > 0.7:
        distortion_type = "major_loop"
        # Replay last 30 seconds
        _create_time_loop()
    elif intensity > 0.4:
        distortion_type = "stuttering"
        # Time stops and starts
        _create_time_stutters()
    else:
        # Just skip forward
        _skip_time_forward(randf_range(1, 5))
    
    reality_glitch_occurred.emit(distortion_type)

func corrupt_text(text: String, corruption_level: float) -> String:
    # Words change when you're not looking
    if corruption_level < 0.3:
        return text
    
    var corruptions = [
        {"find": "help", "replace": "run"},
        {"find": "safe", "replace": "trapped"},
        {"find": "friend", "replace": "enemy"},
        {"find": "home", "replace": "grave"},
        {"find": "hope", "replace": "despair"}
    ]
    
    var corrupted = text
    for c in corruptions:
        if randf() < corruption_level:
            corrupted = corrupted.replace(c.find, c.replace)
    
    # At high corruption, text becomes something else
    if corruption_level > 0.8:
        if randf() < 0.5:
            corrupted = "YOU DID THIS"
        else:
            corrupted = "IT'S TOO LATE"
    
    return corrupted

func _spawn_reality_rift(location: Vector3) -> void:
    # Where perceptions clash, reality tears
    var rift = preload("res://entities/hallucinations/reality_rift.tscn").instantiate()
    
    rift.global_position = location
    rift.configure({
        "holy_side_effect": "healing_light",
        "dark_side_effect": "power_drain", 
        "neutral_effect": "madness",
        "duration": 30.0
    })
    
    get_tree().current_scene.add_child(rift)
    
    # Rifts affect nearby sanity
    Events.emit_signal("environmental_sanity_drain", -2.0, "reality_rift")

# Is it real?
# Does it matter?
# If everyone sees it, is it there?
# In the labyrinth, consensus breaks
<!-- /FILE -->

<!-- FILE: sanity_visuals.gd -->
extends Node
class_name SanityVisuals

# How madness looks

@export var environment: Environment
@export var player_camera: Camera3D

# Visual effects by sanity level
var base_environment_settings: Dictionary = {}
var distortion_shader: Shader
var current_distortion_level: float = 0.0

# Effect components
var shadow_dancers: Array[Node3D] = []
var peripheral_spawner: GPUParticles3D
var reality_glitch_timer: float = 0.0
var false_geometries: Array[MeshInstance3D] = []

# Sanity-specific visuals
var paranoid_effects: Dictionary = {
    "shadow_movement": true,
    "peripheral_flickers": true,
    "color_desaturation": 0.2,
    "edge_darkness": 0.1
}

var hallucinatory_effects: Dictionary = {
    "false_entities": true,
    "geometry_breathing": true, 
    "color_shifting": true,
    "depth_distortion": 0.3
}

var shattered_effects: Dictionary = {
    "reality_fragments": true,
    "multiple_worlds": true,
    "inverted_colors": false,  # Randomly toggles
    "non_euclidean": true
}

func _ready() -> void:
    # Store original environment
    if environment:
        _store_base_environment()
    
    # Load distortion shaders
    distortion_shader = preload("res://shaders/sanity_distortion.gdshader")
    
    # Connect to sanity changes
    SanityController.perception_shifted.connect(_on_perception_shifted)

func _process(delta: float) -> void:
    # Constant subtle changes based on sanity
    var sanity = SanityController.current_sanity
    
    # Update distortion
    current_distortion_level = lerp(current_distortion_level, 
        1.0 - (sanity / 100.0), delta * 0.5)
    
    # Apply visual effects
    if sanity < 70:
        _process_paranoid_visuals(delta)
    
    if sanity < 50:
        _process_hallucinatory_visuals(delta)
        
    if sanity < 30:
        _process_shattered_visuals(delta)

func _store_base_environment() -> void:
    base_environment_settings = {
        "fog_density": environment.fog_density,
        "fog_color": environment.fog_light_color,
        "ambient_color": environment.ambient_light_color,
        "brightness": environment.adjustment_brightness,
        "contrast": environment.adjustment_contrast,
        "saturation": environment.adjustment_saturation
    }

func _on_perception_shifted(new_mode: String) -> void:
    # Major visual shifts
    match new_mode:
        "paranoid":
            _enable_paranoid_mode()
        "hallucinatory":
            _enable_hallucinatory_mode()
        "shattered":
